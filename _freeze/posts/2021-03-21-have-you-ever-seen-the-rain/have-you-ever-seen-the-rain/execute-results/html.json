{
  "hash": "a5a92933dcac5619f019ba8beda79ece",
  "result": {
    "markdown": "---\ntitle: \"Have You Ever Seen the Rain?\"\ndescription: |\n  Explore CHIRPS rainfall data in R\nauthor: Lorena Abad\ndate: 2023-03-21\noutput:\n  distill::distill_article:\n    toc: true\n    toc_float: true\n    toc_depth: 2\n    self_contained: false\ncategories:\n  - r-spatial\n  - stars\n  - earth-engine\n# preview: figs/preview.png\ntwitter:\n  site: \"@loreabad6\"\n  creator: \"@loreabad6\"\ndraft: true\nbibliography: bib.bib\n---\n\n\n\n\n# Background \n\nSome years ago I created a [repository on GitHub](https://github.com/loreabad6/chirps-stars) to document steps on how to load CHIRPS rainfall data into R and explore it using the `stars` package. Since then, my workflows have changed significantly, and my way of accessing this data has evolved. I noticed some people were interested in this repository, so here is a post on two ways I access this data for my current work. \n\n# What is CHIRPS data?\n\n> The Climate Hazards Group Infrared Precipitation with Station data (CHIRPS) is a high-resolution climatic database of precipitation embracing monthly precipitation climatology, quasi-global geostationary thermal infrared satellite observations from the Tropical Rainfall Measuring Mission (TRMM) 3B42 product, atmospheric model rainfall fields from National Oceanic and Atmospheric Administration – Climate Forecast System (NOAA CFS), and precipitation observations from various sources. [@Retalis2017] \n\nOverall it is a combination of station-based observations around the world, and satellite derived data for meteorology, including TRMM and NOAA, which are normally used for precipitation analysis.\n\nThe data covers information from 1981 to the present on a daily, monthly, yearly and decadal basis. It spans latitudes between 50°S and 50°N and all longitudes. The data is presented in a raster format with a cell size of 0.05° or 0.25°. Each of the cells represent a rain gauge [@Funk2015b].\n\n# Accesing the data\n\nThis is not an exhaustive list of how-to access CHIRPS data, but just the two options I work with:\n\n1. Through the Climate Hazards Center (CHC) official repository: https://data.chc.ucsb.edu/\n2. Through Google Earth Engine: https://developers.google.com/earth-engine/datasets/tags/chg\n\n## CHC repository\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(stars)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: abind\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: sf\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.11.2, GDAL 3.6.2, PROJ 9.2.0; sf_use_s2() is TRUE\n```\n:::\n\n```{.r .cell-code}\nlibrary(tidyverse, warn.conflicts = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.3     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.3     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(rnaturalearth)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nThe legacy packages maptools, rgdal, and rgeos, underpinning the sp package,\nwhich was just loaded, will retire in October 2023.\nPlease refer to R-spatial evolution reports for details, especially\nhttps://r-spatial.org/r/2023/05/15/evolution4.html.\nIt may be desirable to make the sf package available;\npackage maintainers should consider adding sf to Suggests:.\nThe sp package is now running under evolution status 2\n     (status 2 uses the sf package in place of rgdal)\nSupport for Spatial objects (`sp`) will be deprecated in {rnaturalearth} and will be removed in a future release of the package. Please use `sf` objects with {rnaturalearth}. For example: `ne_download(returnclass = 'sf')`\n```\n:::\n:::\n\n\nWe can try to download the data with R. Beware, in Windows this can be a bit tricky if not configured correctly (see a related stack overflow question [here](https://stackoverflow.com/questions/51911544/r-crashes-while-opening-netcdf-file)). The code below worked for me. If downloading data at a finer resolution (0.05º) times out, we can always download the data manually from the CRC repository from [this link](https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/netcdf/).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchirps_url = \"https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/netcdf/p25/chirps-v2.0.2023.days_p25.nc\"\nif (!dir.exists(\"temp\")) dir.create(\"temp\")\nif (!file.exists(\"temp/chirps-v2.0.2023.days_p25.nc\")) {\n  download.file(\n    url = chirps_url,\n    destfile = \"temp/chirps-v2.0.2023.days_p25.nc\", \n    mode = \"wb\"\n  )\n}\n```\n:::\n\n\nThen we can read in the data with the stars package. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nchirps_daily_2023 = read_stars(\"temp/chirps-v2.0.2023.days_p25.nc\")\nchirps_daily_2023\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nstars object with 3 dimensions and 1 attribute\nattribute(s), summary of first 1e+05 cells:\n                                    Min. 1st Qu. Median     Mean 3rd Qu.\nchirps-v2.0.2023.days_p25.nc [mm/d]    0       0      0 1.333637       0\n                                        Max.  NA's\nchirps-v2.0.2023.days_p25.nc [mm/d] 137.2787 51001\ndimension(s):\n     from   to         offset  delta  refsys x/y\nx       1 1440           -180   0.25      NA [x]\ny       1  400             50  -0.25      NA [y]\ntime    1   59 2023-01-01 UTC 1 days POSIXct    \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nchirps_daily_2023 |> slice(time, 18) |> plot(breaks = 'equal')\n```\n\n::: {.cell-output-display}\n![](have-you-ever-seen-the-rain_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nI usually perform my analysis at a country or regional scale rather than a global scale, so let's see how we can subset this dataset for a specific region. We will use the `rnaturalearth` package to obtain the polygon of a country, in this case, my home country Ecuador.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld = ne_countries(scale = 'medium', returnclass = 'sf')\necuador = world |>\n  filter(admin == 'Ecuador')\n```\n:::\n\n\nTo subset the data, we need to make the Coordinate Reference System (CRS) of both the chirps data and our country sf object the same. Let's check the CRS for both:\n\n\n::: {.cell}\n\n```{.r .cell-code}\necuador_proj = st_transform(ecuador, 4326)\nchirps_daily_2023 = st_set_crs(chirps_daily_2023, 4326)\n\nchirps_ecuador = chirps_daily_2023[ecuador_proj]\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_crop.stars(x, i, crop = crop, ...): st_crop: bounding boxes of x\nand y do not overlap\n```\n:::\n\n```{.r .cell-code}\nchirps_ecuador[,,,1:9] |> plot()\n```\n\n::: {.cell-output-display}\n![](have-you-ever-seen-the-rain_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntime_series = st_apply(chirps_ecuador, \"time\", mean, na.rm = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_stars(data = chirps_ecuador[,,,1:12]) +\n  scale_fill_viridis_c(\"Precipitation (mm/day)\", na.value = 'white') +\n  facet_wrap(~time) +\n  coord_sf() +\n  theme_void() +\n  theme(legend.position = 'top')\n```\n\n::: {.cell-output-display}\n![](have-you-ever-seen-the-rain_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntime_series |> \n  as_tibble() |> \n  ggplot() +\n  geom_line(aes(y = mean, x = time)) +\n  scale_y_continuous(\"Mean precipitation (mm/day)\")\n```\n\n::: {.cell-output-display}\n![](have-you-ever-seen-the-rain_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Descargar provincias y cantones de Ecuador\nif (!dir.exists(\"temp\")) dir.create(\"temp\")\nsrc = 'http://www.ecuadorencifras.gob.ec//documentos/web-inec/Cartografia/Clasificador_Geografico/2012/SHP.zip'\ndst = 'temp/inec.zip'\nif (!file.exists(dst)) {\n  download.file(src, dst)\n  unzip(dst, exdir = \"temp\")\n}\n```\n:::\n\n\n## Earth Engine\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rgee)\nee_Initialize()\n```\n:::\n",
    "supporting": [
      "have-you-ever-seen-the-rain_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}